name: Update Major Version Tag

on:
  workflow_dispatch:

jobs:
  update-major-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update major version tag
        id: update-tag
        run: |
          NEW_TAG="${{ github.event.release.tag_name }}"
          echo "New release tag: $NEW_TAG"

          if [[ $NEW_TAG =~ ^v([0-9]+)\. ]]; then
            MAJOR_VERSION="v${BASH_REMATCH[1]}"
            echo "major_version=$MAJOR_VERSION" >> $GITHUB_OUTPUT
            
            git config user.name "GitHub Actions"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            if git rev-parse "$MAJOR_VERSION" >/dev/null 2>&1; then
              OLD_VERSION=$(git describe --tags $(git rev-parse $MAJOR_VERSION))
              echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
              echo "Updating $MAJOR_VERSION from $OLD_VERSION to $NEW_TAG"
              git tag -d "$MAJOR_VERSION"
              git push origin ":refs/tags/$MAJOR_VERSION"
            else
              echo "Creating new major version tag $MAJOR_VERSION"
            fi
            
            git tag -a "$MAJOR_VERSION" -m "Update $MAJOR_VERSION to ${NEW_TAG}" "${NEW_TAG}"
            git push origin "$MAJOR_VERSION"
          else
            echo "Error: Invalid tag format"
            exit 1
          fi
